---
- name: Disable Ubuntu auto-updates (apt-daily)
  become: true
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: true
  loop:
    - apt-daily.service
    - apt-daily.timer
    - apt-daily-upgrade.service
    - apt-daily-upgrade.timer
  tags:
    - disable-auto-updates

- name: Wait for APT locks to be released
  become: true
  shell: |
    while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
    sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
    sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
    sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
    echo "APT is locked; waiting..."
    sleep 5
    done
  changed_when: false
  tags:
    - wait-for-apt

- name: Install Ubuntu system packages
  become: "True"
  apt:
    name: "{{ packages }}"
    state: latest
    update_cache: "True"
    cache_valid_time: "{{ apt_cache_valid_time | default (3600) }}"
  vars:
    packages:
      - ca-certificates
      - unzip
      - sudo
      - curl
      - apt-transport-https
      - dbus  # to setup hostname
      - build-essential  # ub18 hasn't it usually
  environment:
    https_proxy: "{{ http_proxy }}"
    http_proxy: "{{ http_proxy }}"
  tags:
    - requirements
