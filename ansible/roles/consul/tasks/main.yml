---
# File: tasks/main.yml - Main tasks for Consul

- name: Check bootstrapped state
  stat:
    path: /etc/consul/.consul_bootstrapped
  register: bootstrap_marker
  ignore_errors: true

- name: Add Consul user
  user:
    name: "{{consul_user}}"
    comment: 'Consul user'
    system: yes

- name: Install specified packages
  include: install.yml

- name: Directories
  file:
    dest: "{{ item }}"
    state: directory
    owner: "{{ consul_user }}"
    group: "{{ consul_group}}"
    recurse: yes
  with_items:
    - "{{consul_data_path}}"
    - "{{consul_log_path}}"
    - "{{consul_pid_dir}}"
    - "{{consul_config_dir}}"
    - "{{consul_config_dir}}/bootstrap"
    - "{{consul_config_dir}}/client"
    - "{{consul_config_dir}}/server"

- name: Bootstrap configuration
  template:
    src: config_bootstrap.json.j2
    dest: "{{ consul_config_dir }}/bootstrap/config.json"
  notify:
    - restart consul

- name: Client configuration
  template:
    src: config_client.json.j2
    dest: "{{ consul_config_dir }}/client/config.json"
  notify:
    - restart consul

- name: Server configuration
  template:
    src: config_server.json.j2
    dest: "{{ consul_config_dir }}/server/config.json"
  notify:
    - restart consul

- include: ../tasks/acl.yml

- block:
  - name: systemd script
    template:
      src: consul_systemd.service.j2
      dest: /lib/systemd/system/consul.service
      owner: root
      group: root
      mode: 644
    when: ansible_service_mgr == "systemd"

  - name: look for bootstap consul
    wait_for:
      port: 8500
      state: present
    register: consul_state

  - name: kill bootstap consul
    shell: pkill -x consul
    when: "'present' in consul_state.state"

  - name: Consul down
    wait_for:
      port: 8301
      state: stopped

  - name: Start Consul
    service:
      name: consul
      state: started
      enabled: yes

  - name: Consul up?
    wait_for:
      delay: 5
      path: "{{consul_pid_dir}}/consul.pid"
      state: present

  - name: Bootstrapped marker
    file:
      dest: /etc/consul/.consul_bootstrapped
      state: touch

  - include: ../tasks/tls.yml
    when: consul_tls_enable

  - include: ../tasks/client.yml
    when: consul_node_role == "client" and ansible_os_family == "Debian"
  
  when: not bootstrap_marker.stat.exists
