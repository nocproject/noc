---
- name: Add Grafana GPG key
  rpm_key:
    key: https://packagecloud.io/gpg.key
    state: present

- name: Add Grafana repository
  template:
    src: os/CentOS/etc/yum.repos.d/grafana.repo.j2
    dest: /etc/yum.repos.d/grafana.repo

- name: Install CentOS packages
  yum:
    name: grafana
    state: latest
    update_cache: yes
  notify: restart grafana

- name: Set up Grafana service
  lineinfile:
    dest: /etc/sysconfig/grafana-server
    regexp: "^{{ item.key }}"
    line: "{{ item.key }}={{ item.value }}"
  with_items:
    - key: DATA_DIR
      value: "{{ noc_root }}/var/db/grafana"
    - key: CONF_DIR
      value: "{{ noc_root }}/var/etc/grafana"
    - key: CONF_FILE
      value: "{{ noc_root }}/var/etc/grafana/grafana.ini"
  notify: restart grafana
