---
- include: "os/{{ ansible_distribution }}/main.yml"

- name: Setup InfluxDB config
  template:
    src: etc/influxdb/influxdb.conf.j2
    dest: "{{ influxdb_conf }}"
  register: s1

- name: Enable InfluxDB system service
  service: name="{{influxdb_system_service}}" enabled=yes state=started
  register: s2

- name: Reload InfluxDB config
  service: name="{{influxdb_system_service}}" state=restarted
  when: "s1.changed and not s2.changed"

- name: Wait for InfluxDB
  wait_for:
    port: 8086
    timeout: 15
    state: present

- name: Create InfluxDB database
  command: "{{ influx_path }} -execute 'CREATE DATABASE IF NOT EXISTS {{ noc_influxdb_db }}'"

- name: Check InfluxDB user
  shell: "{{ influx_path }} -database {{ noc_influxdb_db }} -execute 'show users' | grep {{noc_influxdb_user}}"
  register: us
  changed_when: "us.rc == 1"
  failed_when: "us.rc > 1"

- name: Create InfluxDB user
  command: "{{ influx_path }} -database {{ noc_influxdb_db }} -execute \"CREATE USER {{noc_influxdb_user}} WITH PASSWORD '{{ noc_influxdb_password }}' WITH ALL PRIVILEGES\""
  when: "us.rc == 1"
