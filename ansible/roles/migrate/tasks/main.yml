# Migrate database schema
---
- name: syncdb
  command: ./noc syncdb --noinput
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"

- name: Migrate
  command: ./noc migrate --ignore-ghost-migrations
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"

- name: Set up pools
  copy: content="{{ noc_all_pools | to_json}}" dest="{{ noc_root }}/var/etc/noc/pools.json"

- name: Apply pools
  command: "{{ noc_root }}/scripts/deploy/apply-pools {{ noc_root }}/var/etc/noc/pools.json"
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"

- name: Synchronize collections
  command: ./noc collection --sync
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"

- name: Synchronize permissions
  command: ./noc sync-perm
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"

- name: Synchronize MIBs
  command: ./noc sync-mibs
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
