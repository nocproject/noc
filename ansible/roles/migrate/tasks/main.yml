# Migrate database schema
---

- name: Migrate
  command: ./noc migrate
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"

- name: Apply pools
  command: "{{ noc_root }}/scripts/deploy/apply-pools"
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"

- name: Install collections
  command: "{{ noc_root }}/scripts/deploy/install-packages requirements/{{ item }}.json"
  args:
    chdir: "{{ noc_root }}"
  register: s
  changed_when: "'CHANGED' in s.stdout"
  with_items:
    - collections
  environment:
    http_proxy: "{{http_proxy}}"
    https_proxy: "{{http_proxy}}"
  tags:
    - requirements

- name: Synchronize collections
  command: ./noc collection sync
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
  tags:
    - coll_sync

- name: Synchronize permissions
  command: ./noc sync-perm
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
  tags:
    - perms

- name: Synchronize MIBs
  command: ./noc sync-mibs
  args:
    chdir: "{{ noc_root }}"
  become_user: "{{ noc_user }}"
