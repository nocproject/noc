---
- name: Set mongod-arbiter defaults
  template:
    src: "os/Ubuntu/etc/default/mongod-arbiter.j2"
    dest: "/etc/default/mongod-arbiter"
  when: "ansible_service_mgr != 'systemd'"
  notify: restart mongod-arbiter
  tags:
    - config

- name: Check mongod-arbiter init file
  stat:
    path: /etc/init/mongod-arbiter.conf
  when: "ansible_service_mgr != 'systemd'"
  register: s

- name: Create mongod-arbiter init file
  shell: "sed -e 's/\\/var\\/lib\\/mongodb/\\/opt\\/noc\\/var\\/db\\/mongo-arbiter/g' -e 's/mongodb\\.pid/mongodb-arbiter\\.pid/g' -e 's/\\/etc\\/default\\/mongod/\\/etc\\/default\\/mongod-arbiter/g' < /etc/init/mongod.conf > /etc/init/mongod-arbiter.conf"
  when: "s.stat.islnk is not defined and ansible_service_mgr != 'systemd'"
  notify: restart mongod-arbiter

- name: Create symlink mongod-arbiter init.d file to upstart-job
  file:
    src: /lib/init/upstart-job
    dest: /etc/init.d/mongod-arbiter
    state: link
  when: "ansible_service_mgr != 'systemd'"

- name: Copy mongod-arbiter service file
  template:
    src: os/Ubuntu/etc/systemd/system/mongod-arbiter.service.j2
    dest: /etc/systemd/system/mongod-arbiter.service
  when: "ansible_service_mgr == 'systemd'"
  register: arbiter_service
  notify: restart mongod-arbiter

- name: Reload systemd daemon
  command: /bin/systemctl daemon-reload
  when: "arbiter_service.changed and ansible_service_mgr == 'systemd'"
