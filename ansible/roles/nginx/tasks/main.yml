# nginx role
---
- include: "os/Debian/main.yml"
  when: ansible_distribution == "Debian"

- include: "os/FreeBSD/main.yml"
  when: ansible_distribution == "FreeBSD"

- include: "os/Ubuntu/main.yml"
  when: ansible_distribution == "Ubuntu"

- include: "os/CentOS/main.yml"
  when: ansible_distribution == "CentOS"

- name: Set up SSL certificates
  copy: content="{{ item.content }}" dest="{{ item.path }}" mode=0400 owner="{{ nginx_user }}"
  notify: restart nginx
  with_items:
    - path: "{{ nginx_ssl_key_path }}"
      content: "{{ noc_ssl_key }}"
    - path: "{{ nginx_ssl_cert_path }}"
      content: "{{ noc_ssl_cert }}"

- name: Setup nginx
  template: src="etc/nginx/conf.d/noc.conf.j2" dest="{{ nginx_conf_path }}"
  notify: restart nginx

- name: Install packages
  pip: >
    chdir="{{noc_root}}"
    executable="{{noc_root}}/bin/pip"
    requirements="requirements/web.txt"
    virtualenv="{{noc_root}}"
    extra_args="--trusted-host cdn.nocproject.org --find-links https://cdn.nocproject.org/pkg/simple/ --allow-all-external --upgrade"
  when: "'web' not in group_names"
