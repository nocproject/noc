#
# node role tasks
#
---
- include: "os/Debian/main.yml"
  when: ansible_distribution == "Debian"

- name: Create NOC group
  group: name="{{noc_group}}" state=present

- name: Create NOC user
  user: name="{{noc_user}}" group="{{noc_group}}" comment="NOC user" state=present

- name: Pull NOC
  hg: repo="{{noc_repo}}" dest="{{noc_root}}" revision="{{noc_branch}}"

- name: Upgrade PIP
  pip: >
    chdir="{{noc_root}}"
    executable="{{noc_root}}/bin/pip"
    virtualenv="{{noc_root}}"
    name="pip"

- name: Install python packages
  pip: >
    chdir="{{noc_root}}"
    executable="{{noc_root}}/bin/pip"
    requirements="requirements/node.txt"
    virtualenv="{{noc_root}}"

- name: Create required root directories
  file: path="{{noc_root}}/{{item}}" state="directory"
  with_items:
    - etc/config/env
    - etc/config/services

- name: Create required user directories
  file: path="{{noc_root}}/{{item}}" state="directory" owner="{{noc_user}}"
  with_items:
    - var/log
    - var/run

- name: Check lib/python2.7
  stat: path="{{noc_root}}/lib/python2.7"
  register: py27s

- name: Linking lib/python2.7
  file: src={{noc_root}}/lib/python2.7 dest={{noc_root}}/lib/python state=link
  when: py27s.stat.exists == True

- name: Linking lib/python2.6
  file: src={{noc_root}}/lib/python2.6 dest={{noc_root}}/lib/python state=link
  when: py27s.stat.exists == False

- name: Install noc.pth
  template: src="lib/python/site-packages/noc.pth.j2" dest="{{noc_root}}/lib/python/site-packages/noc.pth"

- name: Check sitecustomize
  stat: path="{{noc_root}}/lib/python/site-packages/sitecustomize.py"
  register: sitecustomizes

- name: Install sitecustomize
  template: src="lib/python/site-packages/sitecustomize.py.j2" dest="{{noc_root}}/lib/python/site-packages/sitecustomize.py"
  when: sitecustomizes.stat.exists == False

- name: Update sitecustomize
  replace: dest="{{noc_root}}/lib/python/site-packages/sitecustomize.py" regexp="ascii" replace="utf-8"
  when: sitecustomizes.stat.exists == True

# @todo: Compile bytecode
# @todo: Check hanging .pyc

- name: Setup supervisord
  template: src="{{item}}" dest={{noc_root}}/{{item[:-3]}}
  with_items:
    - etc/config/env/supervisord.conf.j2
    - etc/config/services/activator.conf.j2
    - etc/config/env/activator.conf.j2
    - etc/config/services/classifier.conf.j2
    - etc/config/env/classifier.conf.j2
    - etc/config/services/correlator.conf.j2
    - etc/config/env/correlator.conf.j2
    - etc/config/services/omap.conf.j2
    - etc/config/env/omap.conf.j2

# @todo: Register supervisor system service
# @todo: Run apply-config when templates changed
# @todo: Reread and update supervisor config

