---
- name: add nsqd group
  group:
    name: nsq

- name: add nsqd user
  user:
    name: nsq
    shell: /bin/false

- name: create path for on-disk queue files
  file:
    path: "{{ item }}"
    state: directory
    mode: 0770
    group: nsq
    owner: nsq
  with_items:
    - "{{noc_root}}/var/db/nsq"
    - "{{noc_root}}/var/etc/nsq"
    - "{{noc_root}}/var/log/nsq"

- name: check if nsq already exists
  stat:
    path: "{{ noc_root }}/bin/nsqd"
  register: nsqd_binary

- name: check if version is ok
  command: "{{ noc_root }}/bin/nsqd --version"
  register: nsq_installed_version
  when: nsqd_binary.stat.isfile is defined

- name: check version
  set_fact: nsq_version_is_ok=True
  when: "nsq_version in nsq_installed_version and nsq_installed_version is defined"

- name: download nsq daemon
  get_url:
    url: https://s3.amazonaws.com/bitly-downloads/nsq/nsq-{{nsq_version}}.linux-amd64.go1.6.tar.gz
    dest: /tmp/nsq-{{nsq_version}}.{{ansible_system.lower()}}-amd64.go1.6.tar.gz
  when: nsqd_binary.stat.isfile is not defined and nsq_version_is_ok is not defined
  environment:
    http_proxy: "{{http_proxy}}"


- name: install nsq
  command: /bin/tar --strip-components=1 -xf /tmp/nsq-{{nsq_version}}.{{ansible_system.lower()}}-amd64.go1.6.tar.gz -C {{ noc_root }}
  args:
    creates: "{{ noc_root }}/bin/nsqd"
  when: nsqd_binary.stat.isfile is not defined and nsq_version_is_ok is not defined

