# Post-deployment tasks
---
- name: Build supervisor config
  command: "{{ noc_root }}/scripts/deploy/apply-config {{ inventory_hostname }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  args:
    chdir: "{{ noc_root }}"

- name: restart telegraf
  service:
    name: telegraf
    state: restarted
    enabled: yes
  changed_when: False
  when: "'FreeBSD' in ansible_distribution"


- name: Start NOC node
  service:
    name: "{{ noc_system_service }}"
    state: restarted
    sleep: 3
    enabled: yes
  changed_when: False

- name: umount cache dir
  mount:
      src: cache
      name: /root/.cache
      state: absent
      fstype: vboxsf
  when: "'virtualbox' in ansible_virtualization_type"
  ignore_errors: yes