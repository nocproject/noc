- name: Check ansible version
  fail:
    msg: "{{ ansible_version.full }} is not supported by this role. Please use at leat 2.2.0.0. See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md for details."
  when: ansible_version is defined and ansible_version.full | version_compare('2.2.0.0', '<')

- name: Check distribution compatibility
  fail:
    msg: "{{ ansible_distribution }} is not supported by this role"
  when: ansible_distribution not in ['RedHat', 'CentOS', 'Debian', 'Ubuntu', 'FreeBSD']

- name: Fail if not a new release of Red Hat / CentOS
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_distribution_version|version_compare(7, '<')

- name: Fail if not a new release of Debian
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution == "Debian" and ansible_distribution_version|version_compare(8.0, '<')

- block:
  - name: tower version is too old
    fail:
      msg: "tower version is '{{tower_version}}' the minimum version is '{{tower_minimum_version}}'. \n\n\n See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md  \n\n\n "
    when: "'old' in tower_version"

  - name: tower version is old
    fail:
      msg: "tower version is '{{tower_version}}' the minimum version is '{{tower_minimum_version}}'. \n\n\n  See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md  \n\n\n "
    when: "tower_version|version_compare(tower_minimum_version, '<')"
  when: tower_version != ''

- name: No mongodb server set
  fail:
    msg: "No mongodb server set. Please setup at least one. "
  when: "'svc-mongod' not in groups"

- name: No postgres server set
  fail:
    msg: "No postgres server set. Please setup one."
  when: "'svc-postgres' not in groups"

- name: Too many postgres servers seted up.
  fail:
    msg: "Too many postgres servers seted up {{groups['svc-postgres'] | count }} on {{groups['svc-postgres']}}"
  when: "'svc-postgres' in groups and groups['svc-postgres'] | count > 1"

- name: Monitoring output is not choosen
  fail:
    msg: "Either PROMETHEUS_ENABLED or INFLUXDB_ENABLED have to be True. otherwise telegraf will not startup"
  when: not telegraf_influxdb_enabled and not telegraf_prometheus_enabled

- name: Ensure tower url
  fail:
    msg: "Please ensure that correct settings has been provided on tower settings page and they was saved."
  when: noc_repo=="http://example.com/hg/VQ3W6R"