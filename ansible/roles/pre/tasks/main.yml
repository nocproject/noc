# Pre-deployment tasks
---

- name: Display all variables/facts known for a host
  debug:
    var: hostvars[inventory_hostname]
    verbosity: 8
  tags:
    - always

- name: notify alerta of deployment
  uri:
    url: "{{alerta_url}}/api/alert?api-key={{alerta_token}}"
    method: POST
    body: "{{ alerta_deploy_start | to_json }}"
    body_format: json
    status_code: 201
    validate_certs: no
  when: "alerta_url and alerta_url is defined and alerta_token is defined and 'prod' in noc_env_type"
  register: alerta_notified
  tags:
    - always

- name: "Loading system-dependend settings"
  include_vars: "os/{{ ansible_distribution }}.yml"
  tags:
    - config
    - always

- name: set proxy
  set_fact:
    http_proxy: "{{ proxy }}"
  when: "proxy is defined"
  tags:
    - config
    - always

- name: "Include OS-specific tasks"
  include: "os/{{ ansible_distribution }}/main.yml"
  tags:
    - config
    - always


- name: Stop NOC node
  service: name="{{ noc_system_service }}" state=stopped
  failed_when: False
  changed_when: False
  tags:
    - restart

- name: Check if vboxsf is supported
  shell: "cat /proc/filesystems"
  register: vboxsf_support
  when: "'virtualbox' in ansible_virtualization_type and 'Linux' in ansible_system"

- name: Mount cache dir
  mount:
      src: cache
      name: /root/.cache
      state: mounted
      fstype: vboxsf
  when: "'virtualbox' in ansible_virtualization_type and 'vboxsf' in vboxsf_support.stdout"
  ignore_errors: yes
