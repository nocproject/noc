# Внешняя система

## Описание

В НОКе реализован базовый функционал **ETL** - возможность извлекать данные из 
**внешней системы** (`Remote System`) и на их основе создавать объекты в НОКе. 
На данный момент возможна загрузка следующих сущностей:

* Зоны ответственности [Administrative Domain](../administrative-domain/index.md)
* Объекты управления [Managed Object](../managed-object/index.md)
* Профили объектов [Manged Object Profile](../managed-object-profile/index.md)
* Сегменты [Segments](../network-segment/index.md)
* Точки присутствия [PoP](../container/index.md)
* Профили аутентификации (`Auth profile`)
* Сервисы [Services](../service/index.md)
* Абоненты [Subscribers](../subscriber/index.md)
* Линки (`Links`) - для построения связей по данным внешней системы [NRI](../../../../admin/reference/discovery/box/nri.md)
* Ресурсные группы [Resource Group](../resource-group/index.md)

Кратко механизм выглядит так:

1. Реализуется **адаптера выгрузки** [extractor](../../../../dev/etl/index.md). Его задача - получить данные из **внешней системы** и отдать в виде списка полей, определённых в `загрузчике` [Loader](../../../../dev/etl/index.md)
2. В интерфейсе настраивается `Внешняя система` и выбираются реализованные `загрузчики`
3. После настройки даётся команда `./noc etl extract <remote_system_name>`. Происходит извлечение информации из внешней системе (при помощи адаптера, написанного на шаге 1). Всё складывается в файлы `import.csv.gz` в директории `/var/lib/noc/import/<remote_system_name>/<loader_name>/import.csv.gz`
4. Командой `./noc etl check <remote_system_name>` проверяем целостность выгрузки
5. Командой `./noc etl diff <remote_system_name>` смотрим изменения относительно предыдущего файла выгрузки. В первым раз все объекты будут показаны как новые.
6. Командой `./noc etl load <remote_system_name>` заливаем данные в НОК (при этом создаются объекты соотв. загрузчику). 

После окончания файл `import.csv.gz` перемещается в папку `/var/lib/noc/import/<remote_system_name>/<loader_name>/arcive/import_date.csv.gz` и файл `mappings.csv` дополняется связкой: `ID внешней системы` <-> `ID НОКа`. Также поля объектов `Remote System`, `Remote ID` - заполняются выгрузкой.

<!-- prettier-ignore -->
!!! info
    Путь `/var/lib/noc/import` задаётся настройкой `path` -> `etl_import`

## Работа с Внешней системой

### Настройка внешней системы

Настройка начинается в пункте меню `Основные (Main) -> Настройки (Setup) -> Внешние системы (Remote Systems)`. 
После нажатия на кнопку `Add` открывается форма создания внешней системы с пунктами:

* Имя (`Name`) - имя внешней системы. Будет использоваться при работе с командой `ETL`. Желательно выбирать краткое и без пробелов.
* Описание (`Description`) - описание (какой-нибудь текст)
* Адаптер (`Handler`) - ссылка на [адаптер выгрузки](../../../../dev/etl/index.md) в виде строчки импорта питона. 
  > Н-р: `noc.custom.etl.extractors.zabbix.ZBRemoteSystem` рассчитывает, что файл лежит в [custom](../../../../dev/custom/index.md) по пути `<custom_folder>/etl/extractor/zabbix.py`
* `Extractors/Loaders` - список доступных для моделей для загрузки. *Требует реализацию в адаптере*
* `Environment` - настройки адаптера загрузки (передаются в него при работе)

### Настройки интеграции

Также, в объектах, поддерживающих создание из механизма `ETL` присутствуют поля:

* Внешняя система (`Remote System`) - это указание из какой внешней системы приехал объект
* ИД во внешней системе (`Remote ID`) - текстовое поле, ID объекта во внешней системе

<!-- prettier-ignore -->
!!! note
    Поля `Remote System`, `Remote ID` заполняются автоматически. Вносить изменения вручную не рекомендуется


После настройки внешней системы дальнейшая работа идёт с командой [./noc etl](../../../../admin/reference/man/etl.md).

## API для получения привязки с внешними системами

[NBI Mappper](../../../../dev/reference/api/nbi/getmappings.md)