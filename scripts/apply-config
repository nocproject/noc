#!./bin/python
# -*- coding: utf-8 -*-
##----------------------------------------------------------------------
## Generate etc/supervisord.conf
##----------------------------------------------------------------------
## Copyright (C) 2007-2015 The NOC Project
## See LICENSE for details
##----------------------------------------------------------------------

## Python modules
import os
import glob
import ConfigParser
import cStringIO

CFG = "etc/supervisord.conf"


def format_env(env):
    """
    Build environment string
    """
    def q(s):
        return str(s).replace("%", "%%")
    return ",".join("%s=\"%s\"" % (k, q(env[k])) for k in env)


def build():
    config = ConfigParser.RawConfigParser()
    # Read configs
    for ge in [
        "etc/defaults/supervisor/*.conf",
        "etc/defaults/services/*.conf",
        "etc/config/supervisor/*.conf",
        "etc/config/services/*.conf"
    ]:
        for path in glob.glob(ge):
            config.read(path)
    # Read environments
    env = {}
    env_config = ConfigParser.RawConfigParser()
    env_config.optionxform = str  # Preserve case
    for path in glob.glob("etc/config/env/*.conf"):
        env_config.read(path)
    for s in env_config.sections():
        env[s] = {}
        for o in env_config.options(s):
            env[s][o] = env_config.get(s, o)
    # @todo: Check for required options
    noc_env = env["supervisord"]["NOC_ENV"]
    noc_dc = env["supervisord"]["NOC_DC"]
    noc_node = env["supervisord"]["NOC_NODE"]
    # Build config
    out = ConfigParser.ConfigParser()
    for s in config.sections():
        # Build service's environment
        de = {}
        if s == "supervisord":
            pn = s
        elif s.startswith("program:"):
            pn = s[8:]
            de["NOC_CONF"] = ":".join([
                "noc/%s/config/global/%s/" % (noc_env, pn),
                "noc/%s/config/dc/%s/node/%s/%s/" % (
                    noc_env, noc_dc, noc_node, pn)
            ])
        else:
            pn = None
        if pn:
            de.update(env.get(pn, {}))
            if de:
                ce = ""
                if config.has_option(s, "environment"):
                    ce = config.get(s, "environment") + ","
                ce += format_env(de)
                config.set(s, "environment", ce)
        re = de.copy()  # service + supervisor environment
        re.update(env["supervisord"])
        if (s.startswith("program")
            and config.has_option(s, "pools")
            and config.get(s, "pools")
        ):
            # Clone pooled configuration
            for p in config.get(s, "pools").split(","):
                if ":" in p:
                    pool_name, numprocs = p.split(":")
                else:
                    pool_name, numprocs = p, None
                ns = "%s-%s" % (s, pool_name)
                # Add NOC_POOL environment to expand
                re["NOC_POOL"] = pool_name
                out.add_section(ns)
                # Non-pooled configuration
                for o in config.options(s):
                    if o == "pools":
                        continue
                    v = config.get(s, o)
                    #
                    if o == "environment":
                        v += ","
                        v += format_env({"NOC_POOL": pool_name})
                    # Apply environment variables to parameters
                    for e in re:
                        v = v.replace("%%(ENV_%s)s" % e, re[e])
                    out.set(ns, o, v)
                if numprocs:
                    # Override numprocs
                    out.set(ns, "numprocs", numprocs)
        else:
            out.add_section(s)
            # Non-pooled configuration
            for o in config.options(s):
                v = config.get(s, o)
                # Apply environment variables to parameters
                for e in re:
                    v = v.replace("%%(ENV_%s)s" % e, re[e])
                out.set(s, o, v)
    buffer = cStringIO.StringIO()
    out.write(buffer)
    cfg = buffer.getvalue()
    # Read old config
    with open(CFG) as f:
        old = f.read()
    if old != cfg:
        # Rewrite
        with open(CFG, "w") as f:
            f.write(cfg)

if __name__ == "__main__":
    build()
